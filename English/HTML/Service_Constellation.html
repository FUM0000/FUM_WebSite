<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>星空シミュレーション（簡易リアル）</title>
    <style>
        body {
            margin: 0;
            background: #000;
            overflow: hidden;
            font-family: Arial, Helvetica, sans-serif;
        }

        canvas {
            display: block;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.65);
            color: white;
            padding: 12px;
            border-radius: 8px;
            z-index: 100;
        }

        label {
            display: block;
            margin: 6px 0;
        }

        button {
            margin-top: 8px;
            padding: 6px 12px;
            background: #444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #666;
        }
    </style>
</head>

<body>

    <div id="controls">
        <label>国:
            <select id="country" onchange="updateDefaultByCountry()">
                <option value="JP" selected>日本</option>
                <option value="US">アメリカ (東部)</option>
                <option value="GB">イギリス</option>
                <option value="FR">フランス</option>
                <option value="DE">ドイツ</option>
                <option value="AU">オーストラリア (東部)</option>
                <option value="custom">カスタム</option>
            </select>
        </label>

        <label>緯度 (deg): <input type="number" id="lat" value="35.6895" step="0.1"></label>
        <label>経度 (deg): <input type="number" id="lon" value="139.6917" step="0.1"></label>
        <p id="standardMeridian" style="margin:8px 0; font-size:0.9em; color:#aaa;">
            標準子午線: 135°E (東京)
        </p>

        <label>日付: <input type="date" id="date"></label>
        <label>時間 (現地時): <input type="time" id="time" step="1"></label>
        <button type="button" onclick="simulate()">表示更新</button>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.171.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.171.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">

        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        const stars = [
            // ── 極めて明るい（-2等級 ～ -0.5等級クラス） ──
            { name: 'Sirius', ra: 101.2872, dec: -16.7161, mag: -1.46, color: '#ffffff' },    // 純白（わずかに青み）
            { name: 'Canopus', ra: 95.9879, dec: -52.6957, mag: -0.74, color: '#fffaf0' },    // 暖かみのある白
            { name: 'Alpha Centauri', ra: 219.9021, dec: -60.8339, mag: -0.27, color: '#ffffff' },    // 非常に明るい白

            // ── 0等級クラス ──
            { name: 'Arcturus', ra: 213.9153, dec: 19.1824, mag: -0.05, color: '#ffe4c4' },    // 淡いオレンジがかった白
            { name: 'Vega', ra: 279.2347, dec: 38.7837, mag: 0.03, color: '#f0f8ff' },    // 青白い
            { name: 'Capella', ra: 79.1723, dec: 45.9980, mag: 0.08, color: '#fffacd' },    // やや暖色がかった白
            { name: 'Rigel', ra: 78.6345, dec: -8.2016, mag: 0.18, color: '#e6f0fa' },    // 青みが強い白
            { name: 'Procyon', ra: 114.8258, dec: 5.2247, mag: 0.34, color: '#fffaf0' },    // 白～わずかに暖色

            // ── 0.5～1.0等級クラス ──
            { name: 'Achernar', ra: 24.4285, dec: -57.2368, mag: 0.45, color: '#f0f8ff' },    // 青白い
            { name: 'Betelgeuse', ra: 88.7929, dec: 7.4071, mag: 0.42, color: '#ff4500' },    // 強い赤（変光星）
            { name: 'Hadar', ra: 203.8640, dec: -60.3829, mag: 0.61, color: '#e6f0fa' },    // 青白い
            { name: 'Altair', ra: 297.6958, dec: 8.8683, mag: 0.77, color: '#ffffff' },    // 白
            { name: 'Acrux', ra: 186.6495, dec: -63.0991, mag: 0.77, color: '#e6f0fa' },    // 青白い
            { name: 'Aldebaran', ra: 68.9802, dec: 16.5093, mag: 0.87, color: '#ff8c00' },    // 強いオレンジ赤

            // ── 1.0～1.5等級クラス ──
            { name: 'Spica', ra: 201.2983, dec: -11.1614, mag: 0.98, color: '#e6f0fa' },    // 青白い
            { name: 'Antares', ra: 247.3519, dec: -26.4320, mag: 1.06, color: '#ff2d2d' },    // 強い赤
            { name: 'Pollux', ra: 116.3289, dec: 28.0262, mag: 1.14, color: '#ffa07a' },    // オレンジ
            { name: 'Fomalhaut', ra: 344.4127, dec: -29.6222, mag: 1.16, color: '#ffffff' },    // 白
            { name: 'Deneb', ra: 310.3580, dec: 45.2803, mag: 1.25, color: '#ffffff' },    // 白
            { name: 'Becrux', ra: 186.9725, dec: -59.6888, mag: 1.25, color: '#e6f0fa' },    // 青白い（Mimosa）
            { name: 'Regulus', ra: 152.0929, dec: 11.9672, mag: 1.36, color: '#e6f0fa' },    // 青白い

            // ── 1.5～2.0等級クラス ──
            { name: 'Adhara', ra: 104.6563, dec: -28.9721, mag: 1.50, color: '#e6f0fa' },
            { name: 'Castor', ra: 113.6499, dec: 31.8883, mag: 1.58, color: '#ffffff' },
            { name: 'Shaula', ra: 263.4022, dec: -37.1038, mag: 1.62, color: '#e6f0fa' },
            { name: 'Gacrux', ra: 187.7913, dec: -57.1132, mag: 1.64, color: '#ff6347' },    // 赤
            { name: 'Bellatrix', ra: 81.2827, dec: 6.3497, mag: 1.64, color: '#e6f0fa' },
            { name: 'Elnath', ra: 81.5728, dec: 28.6075, mag: 1.65, color: '#ffffff' },
            { name: 'Miaplacidus', ra: 97.4073, dec: -69.7175, mag: 1.67, color: '#e6f0fa' },
            { name: 'Alnilam', ra: 84.0534, dec: -1.2019, mag: 1.69, color: '#e6f0fa' },    // オリオン座の帯（中央）
            { name: 'Alnair', ra: 330.8939, dec: -46.9600, mag: 1.73, color: '#ffffff' },
            { name: 'Alnitak', ra: 85.1896, dec: -1.9428, mag: 1.74, color: '#e6f0fa' },    // オリオン座の帯（左）
            { name: 'Alioth', ra: 193.5072, dec: 55.9598, mag: 1.76, color: '#ffffff' },
            { name: 'Mirfak', ra: 51.0810, dec: 49.8612, mag: 1.79, color: '#fffacd' },    // 黄白色
            { name: 'Dubhe', ra: 165.9318, dec: 61.7510, mag: 1.81, color: '#ffa07a' },    // オレンジ
            { name: 'Wezen', ra: 108.0290, dec: -26.3932, mag: 1.83, color: '#fffacd' },
            { name: 'Alkaid', ra: 206.8851, dec: 49.3133, mag: 1.85, color: '#ffffff' },
            { name: 'Sargas', ra: 263.4022, dec: -37.1038, mag: 1.86, color: '#e6f0fa' },
            { name: 'Avior', ra: 125.6286, dec: -59.5095, mag: 1.86, color: '#ffa07a' },    // オレンジ
            { name: 'Menkalinan', ra: 94.6407, dec: 44.9474, mag: 1.90, color: '#fffacd' },
            { name: 'Atria', ra: 167.4890, dec: -69.0277, mag: 1.91, color: '#ffa07a' },
            { name: 'Alhena', ra: 103.4080, dec: 16.3990, mag: 1.93, color: '#ffffff' },
            { name: 'Peacock', ra: 306.4110, dec: -56.7350, mag: 1.94, color: '#e6f0fa' },
            { name: 'Polaris', ra: 37.9461, dec: 89.2641, mag: 1.97, color: '#fff5e1' },    // 淡い黄色
            { name: 'Alphard', ra: 141.8969, dec: -8.6586, mag: 1.99, color: '#ffa07a' },

            // ── 2.0～2.5等級クラス（一部） ──
            { name: 'Algieba', ra: 153.0987, dec: 19.8409, mag: 2.01, color: '#fffacd' },
            { name: 'Hamal', ra: 50.9803, dec: 23.4624, mag: 2.01, color: '#ffa07a' },
            { name: 'Diphda', ra: 10.8975, dec: 0.0829, mag: 2.04, color: '#ffffff' },
            { name: 'Nunki', ra: 275.2180, dec: -26.4320, mag: 2.05, color: '#e6f0fa' },
            { name: 'Menkent', ra: 210.2990, dec: -36.3700, mag: 2.06, color: '#ffa07a' },
            { name: 'Alpheratz', ra: 2.1197, dec: 29.0900, mag: 2.07, color: '#ffffff' },
            { name: 'Kochab', ra: 210.7630, dec: 74.1555, mag: 2.07, color: '#fff5e1' },
            { name: 'Rasalhague', ra: 263.4022, dec: 12.5667, mag: 2.08, color: '#ffffff' },
            { name: 'Algol', ra: 47.0422, dec: 40.9570, mag: 2.09, color: '#e6f0fa' },
            { name: 'Mirach', ra: 29.0617, dec: 35.6206, mag: 2.07, color: '#ffccaa' },
            { name: 'Saiph', ra: 86.9392, dec: -9.6696, mag: 2.07, color: '#e6f0fa' },
            { name: 'Denebola', ra: 177.2649, dec: 14.5721, mag: 2.14, color: '#ffffff' },
            { name: 'Eltanin', ra: 263.4070, dec: 51.4890, mag: 2.24, color: '#ffa07a' },
            { name: 'Schedar', ra: 9.1580, dec: 56.5370, mag: 2.24, color: '#ffccaa' },
            { name: 'Mizar', ra: 200.9812, dec: 54.9254, mag: 2.23, color: '#ffffff' },
            { name: 'Mintaka', ra: 83.0017, dec: -0.2991, mag: 2.25, color: '#e6f0fa' },
            { name: 'Caph', ra: 359.5140, dec: 59.1500, mag: 2.28, color: '#ffffff' },
            { name: 'Merak', ra: 165.4602, dec: 56.3825, mag: 2.34, color: '#ffffff' },
            { name: 'Phecda', ra: 178.4572, dec: 53.6950, mag: 2.41, color: '#ffffff' },
            { name: 'Markab', ra: 345.9430, dec: 15.2050, mag: 2.49, color: '#ffffff' },
            { name: 'Scheat', ra: 345.5510, dec: 28.0830, mag: 2.44, color: '#ffccaa' },
            { name: 'Enif', ra: 328.3520, dec: 9.8750, mag: 2.38, color: '#ffccaa' },

        ];

        let scene, camera, renderer, controls, composer;
        let bloomPass;

        // 国ごとのデフォルト設定（東京に変更済み）
        const countryDefaults = {
            JP: { lat: 35.6895, lon: 139.6917, name: "東京", stdMeridian: 135, tzOffset: 9 },
            US: { lat: 40.71, lon: -74.01, name: "ニューヨーク", stdMeridian: -75, tzOffset: -5 },
            GB: { lat: 51.51, lon: -0.13, name: "ロンドン", stdMeridian: 0, tzOffset: 0 },
            FR: { lat: 48.86, lon: 2.35, name: "パリ", stdMeridian: 15, tzOffset: 1 },
            DE: { lat: 52.52, lon: 13.41, name: "ベルリン", stdMeridian: 15, tzOffset: 1 },
            AU: { lat: -33.87, lon: 151.21, name: "シドニー", stdMeridian: 150, tzOffset: 11 }, // 2026年1月は夏時間
            custom: { lat: 35.0, lon: 135.0, name: "カスタム", stdMeridian: null, tzOffset: 9 }
        };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000814);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0.8, 0.3, 0.8);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            // ── Post Processing ──
            composer = new EffectComposer(renderer);
            const renderPass = new RenderPass(scene, camera);
            composer.addPass(renderPass);

            bloomPass = new UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                1,     // strength
                1,    // radius
                0.85      // threshold ← 暗い星はほとんど光らない
            );
            composer.addPass(bloomPass);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.06;
            controls.rotateSpeed = 0.55;
            controls.zoomSpeed = 1.15;

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            composer.render();
        }

        // 以下は元のコードとほぼ同じ（緯度経度・時間計算部分）
        function degToRad(deg) { return deg * Math.PI / 180; }

        function JulianDateFromUnixTime(t) {
            return (t / 86400000) + 2440587.5;
        }

        function greenwichMeanSiderealTime(jd) {
            const t = (jd - 2451545.0) / 36525.0;
            let gmst = 280.46061837 + 360.98564736629 * (jd - 2451545.0) + 0.000387933 * t * t - t * t * t / 38710000;
            gmst = (gmst % 360 + 360) % 360;
            return degToRad(gmst);
        }

        function raDecToAltAz(ra, dec, lat, lon, jd) {
            const gmst = greenwichMeanSiderealTime(jd);
            let lst = gmst + lon;
            let ha = lst - ra;

            ha = ((ha % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
            if (ha > Math.PI) ha -= 2 * Math.PI;

            const sinAlt = Math.sin(lat) * Math.sin(dec) + Math.cos(lat) * Math.cos(dec) * Math.cos(ha);
            const alt = Math.asin(sinAlt);

            let az = Math.atan2(
                Math.sin(ha) * Math.cos(dec),
                Math.cos(ha) * Math.sin(lat) * Math.cos(dec) - Math.sin(dec) * Math.cos(lat)
            );
            az = (az + 2 * Math.PI) % (2 * Math.PI);

            return { az, alt };
        }

        window.updateDefaultByCountry = function () {
            const country = document.getElementById('country').value;
            const def = countryDefaults[country] || countryDefaults.custom;
            document.getElementById('lat').value = def.lat.toFixed(4);
            document.getElementById('lon').value = def.lon.toFixed(4);
            document.getElementById('standardMeridian').textContent =
                def.stdMeridian !== null
                    ? `標準子午線: ${Math.abs(def.stdMeridian)}°${def.stdMeridian >= 0 ? 'E' : 'W'}`
                    : `標準子午線: --- (カスタム)`;
        };

        // 現在の日時を入力欄にセット（日本時間）
        function setCurrentDateTime() {
            const now = new Date();
            // 日本時間に強制（tzOffset=9）
            const jpTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (9 * 3600000));

            const dateStr = jpTime.toISOString().split('T')[0];
            const timeStr = jpTime.toTimeString().slice(0, 5);

            document.getElementById('date').value = dateStr;
            document.getElementById('time').value = timeStr;
        }

        // 16進数をRGBに変換するヘルパー
        function hexToRgb(hex) {
            hex = hex.replace('#', '');
            const bigint = parseInt(hex, 16);
            return {
                r: (bigint >> 16) & 255,
                g: (bigint >> 8) & 255,
                b: bigint & 255
            };
        }

        // ── 暖色（赤・オレンジ・黄系）かどうかを判定 ──
        function isWarmColor(hex) {
            const { r, g, b } = hexToRgb(hex);

            // 基本条件：赤成分がかなり強い
            if (r < 180) return false;  // 赤が弱い → 冷色寄り

            // 暖色判定のメイン条件（以下のいずれかを満たせば暖色）
            const conditions = [
                // 強い赤～赤橙（Betelgeuse, Antares系）
                r > 210 && g < 100 && b < 100,

                // オレンジ～黄橙（Aldebaran, Pollux, Arcturus系）
                r > 210 && g > 120 && g < 200 && b < 140,

                // 淡いオレンジ・黄味がかった白（Arcturus, Menkalinan系）
                r > 230 && g > 180 && b < 160 && (r - g) < 70,

                // 赤みが強いが少し青を含む場合も救済（自然な暖色範囲）
                r > g * 1.35 && r > b * 1.4 && (g + b > 100)
            ];

            return conditions.some(cond => cond === true);
        }

        window.simulate = function () {
            const latDeg = parseFloat(document.getElementById('lat').value) || 35;
            const lonDeg = parseFloat(document.getElementById('lon').value) || 135;
            const dateStr = document.getElementById('date').value;
            const timeStr = document.getElementById('time').value;

            if (!dateStr || !timeStr) return;

            const country = document.getElementById('country').value;
            const tzOffset = countryDefaults[country]?.tzOffset ?? 9;

            const [year, month, day] = dateStr.split('-').map(Number);
            const [hour, min] = timeStr.split(':').map(Number);

            const localDate = new Date(Date.UTC(year, month - 1, day, hour, min, 0));
            const utcDate = new Date(localDate.getTime() - tzOffset * 3600000);
            const jd = JulianDateFromUnixTime(utcDate.getTime());

            const lat = degToRad(latDeg);
            const lon = degToRad(lonDeg);

            // 古い星を削除
            scene.children.forEach(child => {
                if (child.type === 'Points') {
                    scene.remove(child);
                    child.geometry?.dispose();
                    child.material?.dispose();
                }
            });

            const positions = [];
            const colors = [];
            const sizes = [];

            stars.forEach(star => {
                const raRad = degToRad(star.ra);
                const decRad = degToRad(star.dec);

                const { az, alt } = raDecToAltAz(raRad, decRad, lat, lon, jd);

                // if (alt <= 0) return; // 地平線以下は非表示

                const theta = Math.PI / 2 - alt;
                const phi = az;

                const radius = 600;
                const x = radius * Math.sin(theta) * Math.cos(phi);
                const z = radius * Math.sin(theta) * Math.sin(phi);
                const y = radius * Math.cos(theta);

                // サイズ計算（かなり抑えめに）
                let size = (3.0 - star.mag) * 3;
                size = Math.max(6, Math.min(15, size));

                positions.push(x, y, z);

                // 明るさ（発光強度）を色に反映
                const col = new THREE.Color(star.color);

                // 色温度的な暖色系（赤・オレンジ）を少し強く光らせる補正
                const warmBoost = isWarmColor(star.color) ? 6 : 1.0;
                const baseBrightness = Math.pow(2, -star.mag * 0.4);
                const brightness = baseBrightness * warmBoost;
                col.multiplyScalar(brightness * 4.5);

                colors.push(col.r, col.g, col.b);

                sizes.push(size);
            });

            if (positions.length === 0) return;

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

            // カスタムシェーダーで個別サイズをサポート
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    scale: { value: window.innerHeight / 2 }
                },
                vertexShader: `
                    attribute float size;
                    varying vec3 vColor;

                    void main() {
                        vColor = color;
                        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                        gl_PointSize = size * (300.0 / -mvPosition.z); // 遠近法調整
                        gl_Position = projectionMatrix * mvPosition;
                    }
                `,
                fragmentShader: `
                    varying vec3 vColor;
                    void main() {
                        vec2 coord = gl_PointCoord - vec2(0.5);
                        float dist = length(coord);
                        if (dist > 0.49) discard;           // より厳密な円形
                        float alpha = 1.0 - smoothstep(0.40, 0.49, dist); // 柔らかい縁
                        gl_FragColor = vec4(vColor, alpha);
                    }
                `,
                vertexColors: true,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthTest: false,
                depthWrite: false
            });

            const points = new THREE.Points(geometry, material);
            scene.add(points);
        }

        // 初期化＆初回表示
        init();
        updateDefaultByCountry();
        setCurrentDateTime();
        simulate();

    </script>
</body>

</html>