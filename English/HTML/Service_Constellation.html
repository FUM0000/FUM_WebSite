<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="author" content="F U M">
    <meta name="description" content="FUM_Website">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B89KY0993B"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-B89KY0993B');
    </script>
    <link rel="canonical" href="https://fum0000.github.io/FUM_WebSite/English/HTML/index.html">

    <link rel="icon" type="image/x-icon" href="../../Asset/Image/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="../../Asset/Image/Icon_1_2.jpg">
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="../../Asset/CSS/Common.css?v=1.0" rel="stylesheet" />

    <title>Constellation</title>

    <style>
        body {
            width: 0;
            height: 0;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        #App {
            position: relative;
            z-index: 1;
            background-color: transparent !important;
            pointer-events: none;
        }

        #App a,
        #App button,
        #App input,
        #App select,
        #App textarea,
        #App .v-btn,
        #App .v-list-item,
        #App .v-icon {
            pointer-events: auto;
        }

        #controls {
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            top: auto;
            width: 100%;
            min-width: 300px;
            max-height: 17vh;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 16px;
            border-radius: 12px 12px 0 0;
            box-sizing: border-box;
            z-index: 100;
            pointer-events: auto;
            transition: max-height 0.25s ease, padding 0.25s ease;
        }

        #controls.collapsed {
            max-height: 3rem;
            padding: 8px 16px;
            overflow-y: hidden;
            /* 閉じているときはスクロール不可 */
        }

        #controls-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        #controls-title {
            font-size: 1rem;
            font-weight: 600;
        }

        #controls-toggle {
            background: transparent;
            border: 1px solid #888;
            color: #fff;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        #controls-body {
            overflow: hidden;
        }

        /* 閉じているときは中身を非表示にする */
        #controls.collapsed #controls-body {
            display: none;
        }

        /* ラベルをより読みやすく、指でタップしやすく */
        label {
            display: flex;
            flex-direction: column;
            margin: 12px 0;
            font-size: 1.05rem;
        }

        label select,
        label input[type="number"],
        label input[type="date"],
        label input[type="time"] {
            margin-top: 6px;
            padding: 10px 12px;
            font-size: 1.1rem;
            border-radius: 6px;
            border: 1px solid #555;
            background: #111;
            color: white;
            width: 100%;
            box-sizing: border-box;
        }

        /* ボタンも大きく、タップしやすく */
        .button {
            margin-top: 16px;
            padding: 12px 24px;
            font-size: 1.1rem;
            width: 100%;
            background: #555;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        /* PCでは元の位置に戻したい場合（メディアクエリ） */
        @media (min-width: 768px) {
            #controls {
                position: absolute;
                top: 10px;
                left: 10px;
                bottom: auto;
                right: auto;
                width: auto;
                max-height: none;
                padding: 12px;
                border-radius: 8px;
                background: rgba(0, 0, 0, 0.65);
            }

            /* PC でも閉じているときはスクロールさせない */
            #controls.collapsed {
                max-height: 3rem;
                overflow-y: hidden;
            }

            label {
                display: block;
                margin: 6px 0;
                font-size: 1rem;
            }

            .button {
                width: auto;
                margin-top: 8px;
                padding: 6px 12px;
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>

    <canvas id="StarCanvas"></canvas>

    <v-app id="App">
        <template>
            <main-system-bar :drawer="Drawer" @change-drawer="ChangeDrawer">Service > Constellation</main-system-bar>

            <v-main>
                <div id="controls" class="collapsed">
                    <div id="controls-header" onclick="toggleControls()">
                        <span id="controls-title">観測条件</span>
                        <button id="controls-toggle" type="button">開く ▽</button>
                    </div>
                    <div id="controls-body">
                        <label>国:
                            <select id="country" onchange="updateDefaultByCountry()">
                                <option value="JP" selected>日本</option>
                                <option value="US">アメリカ (東部)</option>
                                <option value="GB">イギリス</option>
                                <option value="FR">フランス</option>
                                <option value="DE">ドイツ</option>
                                <option value="AU">オーストラリア (東部)</option>
                                <option value="custom">カスタム</option>
                            </select>
                        </label>

                        <label>緯度 (deg): <input type="number" id="lat" value="35.6895" step="0.1"></label>
                        <label>経度 (deg): <input type="number" id="lon" value="139.6917" step="0.1"></label>
                        <p id="standardMeridian" style="margin:8px 0; font-size:0.9em; color:#aaa;">
                            標準子午線: 135°E (東京)
                        </p>

                        <label>日付: <input type="date" id="date"></label>
                        <label>時間 (現地時): <input type="time" id="time" step="1"></label>
                        <button type="button" class="button" onclick="simulate()">表示更新</button>
                    </div>
                </div>
            </v-main>

            <main-navigation :drawer="Drawer" @change-drawer="ChangeDrawer"></main-navigation>
            <main-footer-simple></main-footer-simple>
        </template>
    </v-app>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="../../Asset/Javascript/Common.js?v=1.03"></script>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.171.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.171.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">

        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        const stars = [
            // Orion
            { name: 'Rigel', ra: 78.6339, dec: -8.2016, mag: 0.18, color: '#dbe9ff' }, // B8Ia 青白
            { name: 'Betelgeuse', ra: 88.7934, dec: 7.4070, mag: 0.42, color: '#ffb07a' }, // M2Ib 橙赤
            { name: 'Bellatrix', ra: 81.2829, dec: 6.3497, mag: 1.64, color: '#c9dbff' }, // B2III 青白
            { name: 'Alnilam', ra: 84.0534, dec: -1.2019, mag: 1.69, color: '#a7c8ff' }, // B0Ia 青
            { name: 'Alnitak A', ra: 85.1901, dec: -1.9426, mag: 1.88, color: '#9fc2ff' }, // O9.7Ib 青
            { name: 'Saiph', ra: 86.9391, dec: -9.6696, mag: 2.07, color: '#a7c8ff' }, // B0.5Ia 青
            { name: 'Mintaka AB', ra: 83.0016, dec: -0.2991, mag: 2.20, color: '#a7c8ff' }, // B0III+O9V 青
            { name: 'Iota Ori', ra: 83.8584, dec: -5.9099, mag: 2.75, color: '#9fc2ff' },
            { name: 'Pi3 Ori', ra: 72.4589, dec: 6.9613, mag: 3.19, color: '#fff4ea' }, // F6V 黄白
            { name: 'Eta Ori', ra: 81.1193, dec: -2.3971, mag: 3.35, color: '#bcd3ff' }, // B1V 青白
            { name: 'Meissa A', ra: 83.7845, dec: 9.9342, mag: 3.47, color: '#9bbcff' }, // O8III 青
            { name: 'Tau Ori', ra: 79.4017, dec: -6.8444, mag: 3.59, color: '#d6e4ff' }, // B5III 青白
            { name: 'Pi4 Ori', ra: 72.8015, dec: 5.6051, mag: 3.68, color: '#c9dbff' }, // B2III 青白
            { name: 'Alnitak B', ra: 85.1900, dec: -1.9428, mag: 3.70, color: '#a7c8ff' }, // B0III+B1IV 青
            { name: 'Pi5 Ori', ra: 73.5629, dec: 2.4407, mag: 3.71, color: '#c9dbff' }, // B2III 青白
            { name: 'Sigma Ori AB', ra: 84.6865, dec: -2.6001, mag: 3.77, color: '#9fc2ff' },  // O9.5V 青  // O9III 青
            { name: 'Omicron2 Ori', ra: 74.0929, dec: 13.5146, mag: 4.06, color: '#ffd2a1' }, // K2III 橙
            { name: 'Phi2 Ori', ra: 84.2264, dec: 9.2914, mag: 4.09, color: '#ffe7c2' }, // G8III-IV 黄
            { name: 'Mu Ori', ra: 90.5958, dec: 9.6474, mag: 4.12, color: '#ffffff' }, // Am 白
            { name: '29 Ori', ra: 80.9868, dec: -7.8079, mag: 4.13, color: '#ffe7c2' }, // G8III 黄
            { name: '32 Ori', ra: 82.6960, dec: 5.9482, mag: 4.20, color: '#d6e4ff' }, // B5V 青白
            { name: 'Pi2 Ori', ra: 72.6530, dec: 8.9003, mag: 4.35, color: '#f8fbff' }, // A1V 白
            { name: 'Phi1 Ori', ra: 83.7052, dec: 9.4896, mag: 4.39, color: '#a7c8ff' }, // B0IV 青
            { name: 'Chi1 Ori', ra: 88.5962, dec: 20.2764, mag: 4.39, color: '#fff4ea' }, // G0V 黄白
            { name: 'Nu Ori', ra: 91.8930, dec: 14.7685, mag: 4.42, color: '#c9dbff' }, // B3IV 青白
            { name: 'Xi Ori', ra: 92.9850, dec: 14.2088, mag: 4.45, color: '#c9dbff' }, // B3IV 青白
            { name: 'Rho Ori', ra: 78.3228, dec: 2.8613, mag: 4.46, color: '#ffc78f' }, // K3III 橙
            { name: 'Pi6 Ori', ra: 74.6371, dec: 1.7140, mag: 4.47, color: '#ffd2a1' }, // K2II 橙
            { name: 'Omega Ori', ra: 84.7965, dec: 4.1215, mag: 4.50, color: '#c9dbff' },  // B3IIIe 青白
        ];

        let scene, camera, renderer, controls, composer;
        let bloomPass;

        // 国ごとのデフォルト設定（東京に変更済み）
        const countryDefaults = {
            JP: { lat: 35.6895, lon: 139.6917, name: "東京", stdMeridian: 135, tzOffset: 9 },
            US: { lat: 40.71, lon: -74.01, name: "ニューヨーク", stdMeridian: -75, tzOffset: -5 },
            GB: { lat: 51.51, lon: -0.13, name: "ロンドン", stdMeridian: 0, tzOffset: 0 },
            FR: { lat: 48.86, lon: 2.35, name: "パリ", stdMeridian: 15, tzOffset: 1 },
            DE: { lat: 52.52, lon: 13.41, name: "ベルリン", stdMeridian: 15, tzOffset: 1 },
            AU: { lat: -33.87, lon: 151.21, name: "シドニー", stdMeridian: 150, tzOffset: 11 }, // 2026年1月は夏時間
            custom: { lat: 35.0, lon: 135.0, name: "カスタム", stdMeridian: null, tzOffset: 9 }
        };

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000814);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100000);
            camera.position.set(0.8, 0.3, 0.8);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, canvas: document.getElementById('StarCanvas') });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            // ── Post Processing ──
            composer = new EffectComposer(renderer);
            const renderPass = new RenderPass(scene, camera);
            composer.addPass(renderPass);

            bloomPass = new UnrealBloomPass(
                new THREE.Vector2(window.innerWidth, window.innerHeight),
                1,     // strength
                1,    // radius
                0.85      // threshold ← 暗い星はほとんど光らない
            );
            composer.addPass(bloomPass);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.06;
            controls.rotateSpeed = 0.55;
            controls.enableZoom = false;
            controls.enablePan = false;
            controls.enableRotate = true;
            camera.fov = 90;
            camera.updateProjectionMatrix();
            function handleZoom(delta) {
                // delta > 0 → ズームアウト（視野角大きく）
                // delta < 0 → ズームイン（視野角小さく）
                const zoomFactor = 1 + delta * 0.0008;
                camera.fov = THREE.MathUtils.clamp(
                    camera.fov * zoomFactor,
                    10,
                    120
                );
                camera.updateProjectionMatrix();
            }
            // マウスホイール
            renderer.domElement.addEventListener('wheel', (event) => {
                event.preventDefault();
                handleZoom(event.deltaY);
            }, { passive: false });
            // ピンチ
            let lastTouchDistance = null;
            let isPinching = false;
            renderer.domElement.addEventListener(
                'touchstart',
                (event) => {
                    if (event.touches.length === 2) {
                        const dx =
                            event.touches[0].clientX -
                            event.touches[1].clientX;
                        const dy =
                            event.touches[0].clientY -
                            event.touches[1].clientY;

                        lastTouchDistance = Math.hypot(dx, dy);
                        isPinching = true;

                        controls.enableRotate = false;
                    }
                },
                { passive: false }
            );
            renderer.domElement.addEventListener(
                'touchmove',
                (event) => {
                    if (event.touches.length !== 2 || !isPinching) return;

                    event.preventDefault();

                    const dx =
                        event.touches[0].clientX -
                        event.touches[1].clientX;
                    const dy =
                        event.touches[0].clientY -
                        event.touches[1].clientY;

                    const currentDistance = Math.hypot(dx, dy);
                    const delta = lastTouchDistance - currentDistance;

                    if (Math.abs(delta) > 0.5) {
                        handleZoom(delta * 10);
                        lastTouchDistance = currentDistance;
                    }
                },
                { passive: false }
            );
            renderer.domElement.addEventListener(
                'touchend',
                (event) => {
                    if (event.touches.length < 2) {
                        lastTouchDistance = null;
                        isPinching = false;

                        controls.enableRotate = true;
                    }
                },
                { passive: false }
            );

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            composer.render();
        }

        // 以下は元のコードとほぼ同じ（緯度経度・時間計算部分）
        function degToRad(deg) { return deg * Math.PI / 180; }

        function JulianDateFromUnixTime(t) {
            return (t / 86400000) + 2440587.5;
        }

        function greenwichMeanSiderealTime(jd) {
            const t = (jd - 2451545.0) / 36525.0;
            let gmst = 280.46061837 + 360.98564736629 * (jd - 2451545.0) + 0.000387933 * t * t - t * t * t / 38710000;
            gmst = (gmst % 360 + 360) % 360;
            return degToRad(gmst);
        }

        function raDecToAltAz(ra, dec, lat, lon, jd) {
            const gmst = greenwichMeanSiderealTime(jd);
            let lst = gmst + lon;
            let ha = lst - ra;

            ha = ((ha % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
            if (ha > Math.PI) ha -= 2 * Math.PI;

            const sinAlt = Math.sin(lat) * Math.sin(dec) + Math.cos(lat) * Math.cos(dec) * Math.cos(ha);
            const alt = Math.asin(sinAlt);

            let az = Math.atan2(
                Math.sin(ha) * Math.cos(dec),
                Math.cos(ha) * Math.sin(lat) * Math.cos(dec) - Math.sin(dec) * Math.cos(lat)
            );
            az = (az + 2 * Math.PI) % (2 * Math.PI);

            return { az, alt };
        }

        window.updateDefaultByCountry = function () {
            const country = document.getElementById('country').value;
            const def = countryDefaults[country] || countryDefaults.custom;
            document.getElementById('lat').value = def.lat.toFixed(4);
            document.getElementById('lon').value = def.lon.toFixed(4);
            document.getElementById('standardMeridian').textContent =
                def.stdMeridian !== null
                    ? `標準子午線: ${Math.abs(def.stdMeridian)}°${def.stdMeridian >= 0 ? 'E' : 'W'}`
                    : `標準子午線: --- (カスタム)`;
        };

        // コントロールの開閉
        window.toggleControls = function () {
            const container = document.getElementById('controls');
            const toggleBtn = document.getElementById('controls-toggle');

            const isCollapsed = container.classList.contains('collapsed');
            if (isCollapsed) {
                container.classList.remove('collapsed');
                toggleBtn.textContent = '閉じる △';
            } else {
                container.classList.add('collapsed');
                toggleBtn.textContent = '開く ▽';
            }
        };

        // 現在の日時を入力欄にセット（日本時間）
        function setCurrentDateTime() {
            const now = new Date();
            // 日本時間に強制（tzOffset=9）
            const jpTime = new Date(now.getTime() + (now.getTimezoneOffset() * 60000) + (9 * 3600000));

            const dateStr = jpTime.toISOString().split('T')[0];
            const timeStr = jpTime.toTimeString().slice(0, 5);

            document.getElementById('date').value = dateStr;
            document.getElementById('time').value = timeStr;
        }

        // 16進数をRGBに変換するヘルパー
        function hexToRgb(hex) {
            hex = hex.replace('#', '');
            const bigint = parseInt(hex, 16);
            return {
                r: (bigint >> 16) & 255,
                g: (bigint >> 8) & 255,
                b: bigint & 255
            };
        }

        // ── 暖色（赤・オレンジ・黄系）かどうかを判定 ──
        function isWarmColor(hex) {
            const { r, g, b } = hexToRgb(hex);

            // 基本条件：赤成分がかなり強い
            if (r < 180) return false;  // 赤が弱い → 冷色寄り

            // 暖色判定のメイン条件（以下のいずれかを満たせば暖色）
            const conditions = [
                // 強い赤～赤橙（Betelgeuse, Antares系）
                r > 210 && g < 100 && b < 100,

                // オレンジ～黄橙（Aldebaran, Pollux, Arcturus系）
                r > 210 && g > 120 && g < 200 && b < 140,

                // 淡いオレンジ・黄味がかった白（Arcturus, Menkalinan系）
                r > 230 && g > 180 && b < 160 && (r - g) < 70,

                // 赤みが強いが少し青を含む場合も救済（自然な暖色範囲）
                r > g * 1.35 && r > b * 1.4 && (g + b > 100)
            ];

            return conditions.some(cond => cond === true);
        }

        window.simulate = function () {
            const latDeg = parseFloat(document.getElementById('lat').value) || 35;
            const lonDeg = parseFloat(document.getElementById('lon').value) || 135;
            const dateStr = document.getElementById('date').value;
            const timeStr = document.getElementById('time').value;

            if (!dateStr || !timeStr) return;

            const country = document.getElementById('country').value;
            const tzOffset = countryDefaults[country]?.tzOffset ?? 9;

            const [year, month, day] = dateStr.split('-').map(Number);
            const [hour, min] = timeStr.split(':').map(Number);

            const localDate = new Date(Date.UTC(year, month - 1, day, hour, min, 0));
            const utcDate = new Date(localDate.getTime() - tzOffset * 3600000);
            const jd = JulianDateFromUnixTime(utcDate.getTime());

            const lat = degToRad(latDeg);
            const lon = degToRad(lonDeg);

            // 古い星を削除
            scene.children.forEach(child => {
                if (child.type === 'Points') {
                    scene.remove(child);
                    child.geometry?.dispose();
                    child.material?.dispose();
                }
            });

            const positions = [];
            const colors = [];
            const sizes = [];

            stars.forEach(star => {
                const raRad = degToRad(star.ra);
                const decRad = degToRad(star.dec);

                const { az, alt } = raDecToAltAz(raRad, decRad, lat, lon, jd);

                // if (alt <= 0) return; // 地平線以下は非表示

                const theta = Math.PI / 2 - alt;
                const phi = az;

                const radius = 600;
                const x = radius * Math.sin(theta) * Math.cos(phi);
                const z = radius * Math.sin(theta) * Math.sin(phi);
                const y = radius * Math.cos(theta);

                // サイズ計算（かなり抑えめに）
                let size = (3.0 - star.mag) * 3;
                size = Math.max(6, Math.min(15, size));

                positions.push(x, y, z);

                // 明るさ（発光強度）を色に反映
                const col = new THREE.Color(star.color);

                // 色温度的な暖色系（赤・オレンジ）を少し強く光らせる補正
                const warmBoost = isWarmColor(star.color) ? 6 : 1.0;
                const baseBrightness = Math.pow(2, -star.mag * 0.4);
                const brightness = baseBrightness * warmBoost;
                col.multiplyScalar(brightness * 4.5);

                colors.push(col.r, col.g, col.b);

                sizes.push(size);
            });

            if (positions.length === 0) return;

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

            // カスタムシェーダーで個別サイズをサポート
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    scale: { value: window.innerHeight / 2 }
                },
                vertexShader: `
                    attribute float size;
                    varying vec3 vColor;

                    void main() {
                        vColor = color;
                        vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
                        gl_PointSize = size * (300.0 / -mvPosition.z); // 遠近法調整
                        gl_Position = projectionMatrix * mvPosition;
                    }
                `,
                fragmentShader: `
                    varying vec3 vColor;
                    void main() {
                        vec2 coord = gl_PointCoord - vec2(0.5);
                        float dist = length(coord);
                        if (dist > 0.49) discard;           // より厳密な円形
                        float alpha = 1.0 - smoothstep(0.40, 0.49, dist); // 柔らかい縁
                        gl_FragColor = vec4(vColor, alpha);
                    }
                `,
                vertexColors: true,
                transparent: true,
                blending: THREE.AdditiveBlending,
                depthTest: false,
                depthWrite: false
            });

            const points = new THREE.Points(geometry, material);
            scene.add(points);
        }

        // 初期化＆初回表示
        init();
        window.addEventListener('DOMContentLoaded', () => {
            updateDefaultByCountry();
            setCurrentDateTime();
            simulate();
        });

        window.vue = new Vue({
            el: '#App',
            vuetify: new Vuetify(),
            mixins: [window.Mixins_Common]
        });

    </script>
</body>

</html>