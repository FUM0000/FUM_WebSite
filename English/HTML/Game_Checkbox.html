<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="author" content="F U M">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B89KY0993B"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-B89KY0993B');
    </script>

    <link rel="icon" type="image/x-icon" href="../../Asset/Image/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="../../Asset/Image/Icon_1_2.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="../../Asset/CSS/Common.css?v=1.0" rel="stylesheet" />

    <title>Checkman</title>

    <style>
        .container-wrapper {
            position: relative;
            width: 100%;
            height: 360px;
            overflow: hidden;
            display: flex;
            align-items: center;
            background: #eee;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .inner {
            display: flex;
            flex-direction: row;
            position: absolute;
            left: 0;
            transition: left 0.1s ease-in-out;
            height: 100%;
        }

        .checkbox-wrapper {
            width: 30px;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 10px;
            flex-shrink: 0;
        }

        .checkbox-container {
            display: inline-block;
            transition: transform 0.1s ease-out;
        }

        input[type="checkbox"] {
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .game-over-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-weight: bold;
            color: #4caf50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.6s;
            text-align: center;
            flex-direction: column;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .game-over-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        #trendChart {
            width: 100%;
            height: 320px;
        }

        #trendChart .modebar {
            position: absolute !important;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
        }
    </style>
</head>

<body>

    <v-app id="App" v-cloak>
        <template>
            <main-system-bar :drawer="Drawer" @change-drawer="ChangeDrawer">Game > Checkman</main-system-bar>

            <v-main id="Main">
                <transition name="Fade_Page">
                    <v-container fluid fill-height class="pa-5" style="display: flex; align-content: center;">

                        <v-row justify="center">
                            <v-col cols="12" md="8" lg="6">
                                <v-card class="mx-auto pa-6" max-width="800">

                                    <div class="header-controls">
                                        <v-btn color="primary" large fab elevation="2" @click="resetGame">
                                            <v-icon>mdi-replay</v-icon>
                                        </v-btn>

                                        <v-text-field v-model.number="total" label="Total" type="number" min="5"
                                            max="200" style="max-width: 100px;" outlined hide-details
                                            @change="resetGameAndClearStats"></v-text-field>
                                    </div>

                                    <div class="container-wrapper" @click="handleContainerClick">
                                        <div class="inner" ref="inner">

                                        </div>
                                        <div class="game-over-overlay" :class="{show: gameCleared}">
                                            CLEAR! {{ timerDisplay }}s
                                        </div>
                                    </div>

                                    <v-card justify="center" class="mt-6 pa-4">
                                        <v-card-title class="justify-center">Analysis</v-card-title>
                                        <div id="trendChart"></div>
                                        <v-list dense class="mt-4">
                                            <v-list-item>
                                                <v-list-item-content class="text-center">
                                                    Best Time: {{ bestTime ? bestTime.toFixed(2) + 's' : '0s' }}
                                                </v-list-item-content>
                                            </v-list-item>
                                            <v-list-item>
                                                <v-list-item-content class="text-center">
                                                    Overall Average: {{ overallAverage ? overallAverage.toFixed(2) +
                                                    's': '0s' }}
                                                </v-list-item-content>
                                            </v-list-item>
                                        </v-list>
                                    </v-card>

                                </v-card>
                            </v-col>
                        </v-row>

                    </v-container>
                </transition>
            </v-main>

            <main-navigation :drawer="Drawer" @change-drawer="ChangeDrawer"></main-navigation>
            <main-footer></main-footer>
        </template>
    </v-app>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="../../Asset/Javascript/Common.js?v=1.03"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script>
        new Vue({
            el: '#App',
            vuetify: new Vuetify(),
            mixins: [window.Mixins_Common],
            data: {
                total: 20,
                currentIndex: 0,
                timerDisplay: "0.00",
                startTime: null,
                timerId: null,
                gameCleared: false,
                historicalTimes: [],          // 各クリア時の最終タイム
                historicalBestTimes: [],      // 各セッションのベスト（今回は最終タイムを代用）
                checkboxContainers: [],
                inner: null
            },
            computed: {
                bestTime() {
                    if (this.historicalTimes.length === 0) return null;
                    return Math.min(...this.historicalTimes);
                },
                overallAverage() {
                    if (this.historicalTimes.length === 0) return null;
                    const sum = this.historicalTimes.reduce((a, b) => a + b, 0);
                    return sum / this.historicalTimes.length;
                }
            },
            methods: {
                createCheckboxes() {
                    this.$refs.inner.innerHTML = '';
                    this.checkboxContainers = [];

                    for (let i = 0; i < this.total; i++) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'checkbox-wrapper';

                        const moving = document.createElement('div');
                        moving.className = 'checkbox-container';

                        const cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.dataset.index = i;

                        moving.appendChild(cb);
                        wrapper.appendChild(moving);
                        this.$refs.inner.appendChild(wrapper);

                        this.checkboxContainers.push(moving);

                        cb.addEventListener('change', e => {
                            const idx = parseInt(e.target.dataset.index);
                            if (idx === this.currentIndex) {
                                this.currentIndex++;
                                this.updateHorizontalPosition();
                                this.startTimerIfNeeded();
                                this.checkIfFinished();
                                e.target.disabled = true;
                                if (this.currentIndex < this.total) {
                                    this.randomizeVerticalPosition(this.currentIndex);
                                }
                            } else {
                                e.target.checked = false;
                            }
                        });
                    }

                    this.updateHorizontalPosition();
                    if (this.total > 0) this.randomizeVerticalPosition(0);
                },

                getMaxOffset() {
                    const height = 360; // container-wrapperの高さ
                    const cbSize = 30;
                    return (height / 2) - (cbSize / 2) - 20;
                },

                randomizeVerticalPosition(idx) {
                    if (idx >= this.checkboxContainers.length) return;
                    const el = this.checkboxContainers[idx];
                    const max = this.getMaxOffset();
                    const factor = idx / (this.total - 1);
                    const currentMax = max * (0.2 + factor * 0.8);
                    const offset = (Math.random() * 2 - 1) * currentMax;
                    el.style.transform = `translateY(${offset}px)`;
                },

                updateHorizontalPosition() {
                    const vw = this.$refs.inner.parentElement.clientWidth;
                    const center = (vw / 2) - (this.currentIndex * 50);
                    this.$refs.inner.style.left = `${center}px`;
                },

                startTimerIfNeeded() {
                    if (this.currentIndex === 1 && !this.startTime) {
                        this.startTime = performance.now();
                        this.timerId = setInterval(() => {
                            const elapsed = ((performance.now() - this.startTime) / 1000).toFixed(2);
                            this.timerDisplay = elapsed;
                        }, 10);
                    }
                },

                checkIfFinished() {
                    if (this.currentIndex === this.total) {
                        clearInterval(this.timerId);
                        this.gameCleared = true;
                        const finalTime = (performance.now() - this.startTime) / 1000;
                        this.historicalTimes.push(finalTime);
                        this.historicalBestTimes.push(finalTime); // 今回は最終タイムをベストとして扱う
                        this.updateChart();
                    }
                },

                handleContainerClick(e) {
                    if (e.target.tagName !== 'INPUT' || e.target.type !== 'checkbox') {
                        if (this.gameCleared) return;
                        if (this.currentIndex > 0) {
                            this.currentIndex--;
                            const prev = this.checkboxContainers[this.currentIndex].querySelector('input');
                            prev.checked = false;
                            prev.disabled = false;
                            this.updateHorizontalPosition();
                            this.randomizeVerticalPosition(this.currentIndex);
                        }
                    }
                },

                resetGameAndClearStats() {
                    this.historicalTimes = [];
                    this.historicalBestTimes = [];
                    this.updateChart();
                    this.resetGame();
                },

                resetGame() {
                    this.currentIndex = 0;
                    this.startTime = null;
                    this.timerDisplay = "0.00";
                    this.gameCleared = false;
                    clearInterval(this.timerId);
                    this.createCheckboxes();
                },

                updateChart() {
                    const el = document.getElementById('trendChart');
                    if (!el) return;

                    const trace1 = {
                        x: Array.from({ length: this.historicalTimes.length }, (_, i) => i + 1),
                        y: this.historicalTimes,
                        name: 'Clear Time',
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#1976D2' }
                    };

                    const layout = {
                        width: el.clientWidth,
                        height: 320,
                        xaxis: { title: 'Number', tickmode: 'linear', dtick: 1 },
                        yaxis: { title: 'Time(s)' },
                        legend: { yanchor: 'bottom', y: -0.3, xanchor: 'center', x: 0.5 },
                        margin: { t: 40, b: 60, l: 60, r: 40 }
                    };

                    const config = {
                        displaylogo: false,
                        displayModeBar: true,
                        responsive: true,
                        modeBarButtons: [
                            ['pan2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d']
                        ],
                    };

                    Plotly.newPlot('trendChart', [trace1], layout, config);
                }
            },
            mounted() {
                this.inner = this.$refs.inner;
                this.createCheckboxes();
                this.updateChart();
                window.addEventListener('resize', () => {
                    this.updateHorizontalPosition();
                    this.updateChart();
                });
            }
        });
    </script>
</body>

</html>