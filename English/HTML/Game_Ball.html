<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="author" content="F U M">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">

    <link rel="shortcut icon" type="image/x-icon" href="../../Asset/Image/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="../../Asset/CSS/Common.css?v=1.0" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.126.1/build/three.module.js';
        import { FBXLoader } from "https://unpkg.com/three@0.126.1/examples/jsm/loaders/FBXLoader.js";

        // Renderer
        const Renderer = new THREE.WebGLRenderer({ canvas: document.querySelector("#Canvas_1"), antialias: true });
        Renderer.setPixelRatio(window.devicePixelRatio);
        Renderer.setSize(window.innerWidth, window.innerHeight);
        window.addEventListener('resize', ResizeScreen, false);
        Renderer.setClearColor(new THREE.Color(0xFCA3B7));

        const Scene = new THREE.Scene();

        // フォグ（遠くをぼかす）
        Scene.fog = new THREE.Fog(0xFCA3B7, 3, 12);

        const Loader_FBX = new FBXLoader();

        // カメラ回転制御
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let cameraRotation = { x: 0, y: 0 };

        document.addEventListener('touchstart', e => TouchStart(e.touches[0].clientX, e.touches[0].clientY));
        document.addEventListener('touchmove',  e => TouchMove (e.touches[0].clientX, e.touches[0].clientY));
        document.addEventListener('touchend',   () => TouchEnd());
        document.addEventListener('mousedown',  e => TouchStart(e.clientX, e.clientY));
        document.addEventListener('mousemove',  e => TouchMove (e.clientX, e.clientY));
        document.addEventListener('mouseup',    () => TouchEnd());

        // 定数
        let DeltaTime = 1 / 60;
        const Gravity = 9.8;
        const CalculationError_Time = 0.1;
        const Resistance = 0.998;

        // カメラクラス
        class Base_Camera_1_CLASS {
            #Object;
            constructor() {
                this.#Object = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.01, 30);
                this.#Object.position.set(0, 1.5, -1.5);
                this.#Object.lookAt(0, 0, 2);
            }
            Update() {
                this.#Object.rotation.order = 'YXZ';
                this.#Object.rotation.x = cameraRotation.x;
                this.#Object.rotation.y = cameraRotation.y;
                this.#Object.rotation.z = 0;
            }
            Get_Object() { return this.#Object; }
        }

        // タイマー制御クラス
        class Base_InputControler_1_CLASS {
            #Time_Flag_Finishing = true;
            #Time_Flag_Using = false;
            #Time_Timer = 0;
            Update() {
                if (this.#Time_Flag_Using) {
                    setTimeout(() => {
                        this.#Time_Flag_Using = false;
                        this.#Time_Flag_Finishing = true;
                    }, this.#Time_Timer * 1000);
                }
            }
            Get_Time_Flag_Finishing() { return this.#Time_Flag_Finishing; }
            Set_Timer(_time) {
                if (!this.#Time_Flag_Using) {
                    this.#Time_Timer = _time;
                    this.#Time_Flag_Using = true;
                    this.#Time_Flag_Finishing = false;
                }
            }
        }

        // ライト
        class Base_Light_Ambient_1_CLASS {
            constructor() {
                const light = new THREE.AmbientLight(0xffffff, 0.7);
                Scene.add(light);
            }
        }
        class Base_Light_Directional_1_CLASS {
            constructor() {
                const light = new THREE.DirectionalLight(0xffffff, 0.8);
                light.position.set(5, 10, 3);
                Scene.add(light);
            }
        }

        // ゲームマネージャ
        class Base_Manager_1_CLASS {
            #State = "Made";
            #Level = 1;
            #UI_Home_1;
            #UI_Start_1;
            #UI_Clear_1;
            #UI_Level_1;

            constructor() {
                // UI作成
                this.#UI_Home_1 = document.createElement('div');
                this.#UI_Home_1.id = "UI_Home_1";
                this.#UI_Home_1.innerHTML = "HOME";
                document.body.appendChild(this.#UI_Home_1);

                // リセットボタンを追加
                const UI_Reset_1 = document.createElement('div');
                UI_Reset_1.id = "UI_Reset_1";
                UI_Reset_1.innerHTML = "RESET";
                document.body.appendChild(UI_Reset_1);

                this.#UI_Start_1 = document.createElement('div');
                this.#UI_Start_1.id = "UI_Start_1";
                document.body.appendChild(this.#UI_Start_1);

                this.#UI_Clear_1 = document.createElement('div');
                this.#UI_Clear_1.id = "UI_Clear_1";
                document.body.appendChild(this.#UI_Clear_1);

                this.#UI_Level_1 = document.createElement('div');
                this.#UI_Level_1.id = "UI_Level_1";
                this.#UI_Level_1.innerHTML = "Level: 1";
                document.body.appendChild(this.#UI_Level_1);

                const UI_Shoot_1 = document.createElement('div');
                UI_Shoot_1.id = "UI_Shoot_1";
                UI_Shoot_1.innerHTML = "発射";
                document.body.appendChild(UI_Shoot_1);

                UI_Shoot_1.addEventListener('click', () => {
                    if (this.#State === "Playing") Ball_1.Shoot();
                });

                UI_Reset_1.addEventListener('click', () => {
                    this.Ready();
                });

                $("#UI_Home_1").click(() => {
                    window.location.href = '../../English/HTML/index.html';
                });
            }
            Initialize() {
                this.#State = "WaitingStart";
                this.#UI_Start_1.innerHTML = "";
            }
            Get_State() { return this.#State; }
            Set_State(_state) { this.#State = _state; }
            Get_Level() { return this.#Level; }
            Ready() {
                this.#State = "WaitingStart";
                this.#UI_Start_1.innerHTML = "START";
                this.#UI_Clear_1.innerHTML = "";
                Ball_1.Initialize();
                Progress_1.Initialize();
            }
            Start() {
                this.#State = "Playing";
                this.#UI_Start_1.innerHTML = "";
            }
            Clear() {
                this.#State = "Goal";
                this.#UI_Clear_1.innerHTML = "WOOOW! Level Up!";
                this.#Level++;
                this.#UI_Level_1.innerHTML = "Level: " + this.#Level;
                Ball_1.Set_Difficulty(this.#Level);
                PaperCup_1.Set_Difficulty(this.#Level);
            }
        }

        // ボール
        class Ball_1_CLASS {
            #Bounce_Count = 0;
            #Bounce_Max = 3;
            #Direction_Move = new THREE.Vector3();
            #ElapsedFrame_Firing = 0;
            #ElapsedFrame_Gravity = 0;
            #Flag_Cup = false;
            #Flag_Shoot = false;
            #Object = null;
            #Radius = 0.08;
            #Speed = 5;
            #Speed_Max = 8;
            #Speed_Base = 1;
            #Velocity_X = 0; #Velocity_Y = 0; #Velocity_Z = 0;
            #X = 0; #Y = 1; #Z = 0;

            constructor() {
                Loader_FBX.load('../../Asset/Model/Ball_PinPon_1.fbx', 
                    obj => {
                        this.#Object = obj;
                        this.#Object.scale.set(0.0016, 0.0016, 0.0016);
                        Scene.add(this.#Object);
                    },
                    undefined,
                    err => console.error(err)
                );
            }

            Initialize() {
                this.#Bounce_Count = 0;
                this.#ElapsedFrame_Firing = 0;
                this.#ElapsedFrame_Gravity = 0;
                this.#Flag_Cup = false;
                this.#Flag_Shoot = false;
                this.#Velocity_X = this.#Velocity_Y = this.#Velocity_Z = 0;
                this.#Speed = this.#Speed_Base;
                this.#X = 0; this.#Y = 1; this.#Z = 0;
                if (this.#Object) this.#Object.position.set(0,1,0);
            }

            Update() {
                if (!this.#Flag_Shoot) {
                    const cam = Base_Camera_1.Get_Object();
                    const dir = new THREE.Vector3();
                    cam.getWorldDirection(dir);
                    const dist = 0.5;
                    this.#X = cam.position.x + dir.x * dist;
                    this.#Y = cam.position.y + dir.y * dist;
                    this.#Z = cam.position.z + dir.z * dist;
                    if (this.#Object) this.#Object.position.set(this.#X, this.#Y, this.#Z);
                }

                if (this.#Flag_Shoot) {
                    this.#ElapsedFrame_Firing += DeltaTime;
                    if (this.#ElapsedFrame_Firing >= CalculationError_Time) {
                        this.#ElapsedFrame_Firing = 0;
                        this.Update_Shoot();
                    }
                }

                if (this.#Object) {
                    this.#Object.position.set(this.#X, this.#Y, this.#Z);
                }
            }

            Update_Shoot() {
                this.#Velocity_X *= Resistance;
                this.#Velocity_Z *= Resistance;

                this.#X += this.#Velocity_X * DeltaTime;
                this.#Y += this.#Velocity_Y * DeltaTime;
                this.#Z += this.#Velocity_Z * DeltaTime;

                this.#ElapsedFrame_Gravity += DeltaTime;
                if (this.#ElapsedFrame_Gravity >= CalculationError_Time) {
                    this.#ElapsedFrame_Gravity = 0;
                    this.#Velocity_Y -= Gravity * DeltaTime * 2; // 少し重めに
                }

                // 床との衝突（y=0）
                if (this.#Y <= this.#Radius) {
                    this.#Y = this.#Radius;
                    this.#Velocity_Y *= -0.75; // バウンド減衰
                    this.#Bounce_Count++;

                    if (this.#Bounce_Count >= this.#Bounce_Max) {
                        this.#Flag_Shoot = false;
                        Base_Manager_1.Ready();
                    }
                }

                // カップに入ったか
                if (PaperCup_1.Get_Object() && !this.#Flag_Cup) {
                    const dist = this.#Object.position.distanceTo(PaperCup_1.Get_Object().position);
                    if (dist <= PaperCup_1.Get_Radius() + this.#Radius &&
                        this.#Y >= PaperCup_1.Get_Height() - 0.12 &&
                        this.#Velocity_Y < 0) {
                        this.#Flag_Cup = true;
                        Base_Manager_1.Clear();
                        Base_InputControler_1.Set_Timer(2.5);
                    }
                }
            }

            Get_Object() { return this.#Object; }
            Set_Difficulty(level) {
                this.#Speed_Base = 1;
            }
            Shoot() {
                const power = Progress_1.Get_Percentage() / 100;
                this.#Speed = this.#Speed_Base + (this.#Speed_Max - this.#Speed_Base) * power;

                const cam = Base_Camera_1.Get_Object();
                const dir = new THREE.Vector3();
                cam.getWorldDirection(dir);

                this.#Velocity_X = dir.x * this.#Speed;
                this.#Velocity_Y = dir.y * this.#Speed;
                this.#Velocity_Z = dir.z * this.#Speed;

                this.#Flag_Shoot = true;
            }
        }

        // 紙コップ
        class PaperCup_1_CLASS {
            #Height = 0.5;
            #Object = null;
            #Radius = 1;
            #X = 0; #Y = 0; #Z = 2;

            #Scale = 0.05;

            constructor() {
                Loader_FBX.load('../../Asset/Model/Cup_Paper_1.fbx',
                    obj => {
                        this.#Object = obj;
                        this.#Object.scale.set(this.#Scale, this.#Scale, this.#Scale);
                        this.#Object.position.set(0, 0, 2);
                        Scene.add(this.#Object);
                    },
                    undefined,
                    err => console.error(err)
                );
            }

            Get_Object() { return this.#Object; }
            Get_Radius() { return this.#Radius; }
            Get_Height() { return this.#Height; }
            Set_Difficulty(level) {
                this.#Z = 2;
                if (this.#Object) this.#Object.position.z = this.#Z;
            }
        }

        // パワーゲージ
        class Progress_1_CLASS {
            #Element;
            #MoveDirection = 1;
            constructor() {
                this.#Element = document.getElementById('Progress_1');
            }
            Update() {
                if (Base_Manager_1.Get_State() === "Playing") {
                    this.#Element.value += this.#MoveDirection * 2.2;
                    if (this.#Element.value >= 100) {
                        this.#Element.value = 100;
                        this.#MoveDirection = -1;
                    } else if (this.#Element.value <= 0) {
                        this.#Element.value = 0;
                        this.#MoveDirection = 1;
                    }
                }
            }
            Initialize() { this.#Element.value = 0; }
            Get_Percentage() { return this.#Element.value; }
        }

        // 床（大きな板）
        function CreateFloor() {
            const geometry = new THREE.PlaneGeometry(30, 30);
            const material = new THREE.MeshStandardMaterial({ 
                color: 0x000000,
                roughness: 0.9 
            });
            const floor = new THREE.Mesh(geometry, material);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = 0;
            floor.receiveShadow = true;
            Scene.add(floor);
        }

        // インスタンス生成
        const Base_Camera_1       = new Base_Camera_1_CLASS();
        const Base_InputControler_1 = new Base_InputControler_1_CLASS();
        new Base_Light_Ambient_1_CLASS();
        new Base_Light_Directional_1_CLASS();
        const Base_Manager_1      = new Base_Manager_1_CLASS();
        const Ball_1              = new Ball_1_CLASS();
        const PaperCup_1          = new PaperCup_1_CLASS();
        const Progress_1          = new Progress_1_CLASS();

        CreateFloor();           // 床追加

        Base_Manager_1.Ready();

        // アニメーションループ
        function Loop() {
            Base_InputControler_1.Update();

            if (Base_Manager_1.Get_State() === "Playing") {
                Ball_1.Update();
                Progress_1.Update();
            }

            Base_Camera_1.Update();

            Renderer.render(Scene, Base_Camera_1.Get_Object());
            requestAnimationFrame(Loop);
        }
        Loop();

        function ResizeScreen() {
            const cam = Base_Camera_1.Get_Object();
            cam.aspect = window.innerWidth / window.innerHeight;
            cam.updateProjectionMatrix();
            Renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function TouchStart(x, y) {
            if (Base_InputControler_1.Get_Time_Flag_Finishing()) {
                const state = Base_Manager_1.Get_State();
                if (state === "WaitingStart") {
                    Base_Manager_1.Start();
                } else if (state === "Playing") {
                    isDragging = true;
                    previousMousePosition = { x, y };
                } else if (state === "Goal") {
                    Base_Manager_1.Ready();
                }
            }
            Base_InputControler_1.Set_Timer(0.1);
        }

        function TouchMove(x, y) {
            if (Base_Manager_1.Get_State() === "Playing" && isDragging) {
                const dx = x - previousMousePosition.x;
                const dy = y - previousMousePosition.y;

                cameraRotation.y -= dx * 0.004;
                cameraRotation.x -= dy * 0.004;
                cameraRotation.x = Math.max(-Math.PI/2 + 0.1, Math.min(Math.PI/2 - 0.1, cameraRotation.x));

                previousMousePosition = { x, y };
            }
        }

        function TouchEnd() {
            isDragging = false;
        }
    </script>

    <style>
        body { margin:0; overflow:hidden; }
        #Canvas_1 { display:block; }

        #UI_Home_1 {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 1.5em;
            font-weight: bold;
            color: #e00;
            cursor: pointer;
            user-select: none;
        }

        #UI_Reset_1 {
            position: absolute;
            top: 16px;
            left: 16px;
            font-size: 1.5em;
            font-weight: bold;
            color: #0066cc;
            cursor: pointer;
            user-select: none;
            background: rgba(255,255,255,0.7);
            padding: 4px 12px;
            border-radius: 8px;
        }
        #UI_Reset_1:active {
            transform: scale(0.95);
        }

        #UI_Level_1 {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.6em;
            font-weight: bold;
            color: #222;
            background: rgba(255,255,255,0.7);
            padding: 4px 16px;
            border-radius: 8px;
        }

        #UI_Clear_1 {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3.2em;
            font-weight: bold;
            color: #ff4444;
            text-shadow: 3px 3px 6px #0008;
            pointer-events: none;
            animation: pop 0.6s infinite alternate;
        }
        @keyframes pop {
            from { transform: translate(-50%, -50%) scale(1); }
            to   { transform: translate(-50%, -50%) scale(1.12); }
        }

        #UI_Start_1 {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            font-weight: bold;
            color: #e00;
            text-shadow: 2px 2px 5px #0006;
            pointer-events: none;
        }

        #UI_Shoot_1 {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.9em;
            font-weight: bold;
            color: white;
            background: #ff4444;
            padding: 16px 48px;
            border-radius: 12px;
            box-shadow: 0 5px 12px #0006;
            user-select: none;
            cursor: pointer;
        }
        #UI_Shoot_1:active {
            transform: translateX(-50%) scale(0.94);
            box-shadow: 0 2px 6px #0004;
        }

        #Progress_1 {
            position: absolute;
            bottom: 110px;
            left: 50%;
            transform: translateX(-50%);
            width: 260px;
            height: 18px;
            border-radius: 9px;
            background: rgba(0,0,0,0.3);
        }
        #Progress_1::-webkit-progress-bar {
            background: rgba(255,255,255,0.25);
            border-radius: 9px;
        }
        #Progress_1::-webkit-progress-value {
            background: linear-gradient(90deg, #ff4444, #ffaa00);
            border-radius: 9px;
            transition: width 0.08s linear;
        }
    </style>
</head>
<body>
    <canvas id="Canvas_1"></canvas>
    <progress id="Progress_1" value="0" max="100"></progress>

</body>
</html>