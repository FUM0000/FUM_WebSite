<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="author" content="F U M">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-B89KY0993B"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-B89KY0993B');
    </script>

    <link rel="icon" type="image/x-icon" href="../../Asset/Image/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="../../Asset/Image/Icon_1_2.jpg">
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Zen+Kaku+Gothic+New:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="../../Asset/CSS/Common.css?v=1.0" rel="stylesheet" />

    <title>Setting</title>

    <style>
        html {
            user-select: auto;
        }
    </style>
</head>

<body>
    <v-app id="App">
        <template>

            <main-system-bar :drawer="Drawer" @change-drawer="ChangeDrawer">Setting</main-system-bar>
            <main-navigation :drawer="Drawer" @change-drawer="ChangeDrawer"></main-navigation>

            <v-main id="Main">
                <transition name="Fade_Page">
                    <v-container v-show="Ready_Page" fluid class="pa-5">

                        <v-row justify="center">

                            <v-col cols="12" md="8">

                                <!-- 自動保存設定 -->
                                <v-card class="mb-4">
                                    <v-card-text class="pa-4">
                                        <v-row align="center">
                                            <v-col>
                                                <div class="d-flex align-center">
                                                    <v-icon left>mdi-content-save-auto</v-icon>
                                                    <span class="font-weight-bold">Auto Save</span>
                                                </div>
                                            </v-col>
                                            <v-col cols="auto">
                                                <v-switch v-model="autoSave" @change="toggleAutoSave" inset dense
                                                    hide-details></v-switch>
                                            </v-col>
                                        </v-row>
                                    </v-card-text>
                                </v-card>

                                <v-card class="mb-4 sound-card">
                                    <v-card-title class="text-h5 font-weight-bold py-3 d-flex justify-space-between">
                                        <span><v-icon left>mdi-music</v-icon>Sound</span>
                                        <v-btn icon @click="toggleCard('sound')">
                                            <v-icon>{{ soundExpanded ? 'mdi-chevron-up' : 'mdi-chevron-down' }}</v-icon>
                                        </v-btn>
                                    </v-card-title>
                                    <v-expand-transition>
                                        <v-card-text v-show="soundExpanded" class="pa-5">

                                            <!-- BGM選択 -->
                                            <div class="mb-6">
                                                <v-subheader class="px-0 font-weight-bold">
                                                    <v-icon left>mdi-playlist-music</v-icon>
                                                    BGM Selection
                                                </v-subheader>
                                                <v-select v-model="settings.bgm" :items="bgmOptions" outlined dense
                                                    @change="onSettingChange"></v-select>
                                            </div>

                                            <!-- BGMボリューム -->
                                            <div class="mb-6">
                                                <v-subheader class="px-0 font-weight-bold">
                                                    <v-icon left>mdi-volume-high</v-icon>
                                                    BGM Volume: {{ settings.bgmVolume }}%
                                                </v-subheader>
                                                <v-slider v-model="settings.bgmVolume" min="0" max="100" step="5"
                                                    thumb-label @input="onSettingChange"></v-slider>
                                            </div>

                                            <!-- SEボリューム -->
                                            <div class="mb-4">
                                                <v-subheader class="px-0 font-weight-bold">
                                                    <v-icon left>mdi-volume-medium</v-icon>
                                                    SE Volume: {{ settings.seVolume }}%
                                                </v-subheader>
                                                <v-slider v-model="settings.seVolume" min="0" max="100" step="5"
                                                    thumb-label @input="onSettingChange"></v-slider>
                                            </div>

                                        </v-card-text>
                                    </v-expand-transition>
                                </v-card>

                                <v-card class="mb-4 color-card">
                                    <v-card-title class="text-h5 font-weight-bold py-3 d-flex justify-space-between">
                                        <span><v-icon left>mdi-palette</v-icon>Color</span>
                                        <v-btn icon @click="toggleCard('color')">
                                            <v-icon>{{ colorExpanded ? 'mdi-chevron-up' : 'mdi-chevron-down' }}</v-icon>
                                        </v-btn>
                                    </v-card-title>
                                    <v-expand-transition>
                                        <v-card-text v-show="colorExpanded" class="pa-5">

                                            <!-- メインカラー(背景色) -->
                                            <div class="mb-6">
                                                <v-subheader class="px-0 font-weight-bold">
                                                    <v-icon left>mdi-format-color-fill</v-icon>
                                                    Main Color (Background)
                                                </v-subheader>
                                                <v-row align="center">
                                                    <v-col cols="12" sm="8">
                                                        <v-text-field v-model="settings.mainColor" outlined dense
                                                            placeholder="#FFFFFF"
                                                            @input="onSettingChange"></v-text-field>
                                                    </v-col>
                                                    <v-col cols="12" sm="4" class="py-0 mb-6">
                                                        <input type="color" v-model="settings.mainColor"
                                                            @input="onSettingChange"
                                                            style="width: 100%; height: 40px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.38); cursor: pointer; padding: 0;">
                                                    </v-col>
                                                </v-row>
                                            </div>

                                            <!-- サブカラー -->
                                            <div class="mb-4">
                                                <v-subheader class="px-0 font-weight-bold">
                                                    <v-icon left>mdi-palette-advanced</v-icon>
                                                    Sub Color
                                                </v-subheader>
                                                <v-row align="center">
                                                    <v-col cols="12" sm="8">
                                                        <v-text-field v-model="settings.subColor" outlined dense
                                                            placeholder="#000000"
                                                            @input="onSettingChange"></v-text-field>
                                                    </v-col>
                                                    <v-col cols="12" sm="4" class="py-0 mb-6">
                                                        <input type="color" v-model="settings.subColor"
                                                            @input="onSettingChange"
                                                            style="width: 100%; height: 40px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.38); cursor: pointer; padding: 0;">
                                                    </v-col>
                                                </v-row>
                                            </div>

                                            <!-- プレビュー -->
                                            <div class="mb-4">
                                                <v-subheader class="px-0 font-weight-bold">
                                                    <v-icon left>mdi-eye</v-icon>
                                                    Preview
                                                </v-subheader>
                                                <div :style="{
                                                        backgroundColor: settings.mainColor,
                                                        color: settings.subColor,
                                                        padding: '20px',
                                                        borderRadius: '8px',
                                                        border: '2px solid #ddd',
                                                        textAlign: 'center'
                                                    }">
                                                    <h3>Sample Text</h3>
                                                    <p>This is how your colors will look together.</p>
                                                </div>
                                            </div>

                                        </v-card-text>
                                    </v-expand-transition>
                                </v-card>

                                <!-- 保存・キャンセル・デフォルトボタン -->
                                <v-card class="mb-4">
                                    <v-card-text class="pa-4">
                                        <v-row>
                                            <v-col cols="12" sm="4">
                                                <v-btn block large color="primary" @click="saveSettings"
                                                    :disabled="!hasChanges">
                                                    <v-icon left>mdi-content-save</v-icon>
                                                    Save
                                                </v-btn>
                                            </v-col>
                                            <v-col cols="12" sm="4">
                                                <v-btn block large outlined @click="cancelChanges"
                                                    :disabled="!hasChanges">
                                                    <v-icon left>mdi-cancel</v-icon>
                                                    Cancel
                                                </v-btn>
                                            </v-col>
                                            <v-col cols="12" sm="4">
                                                <v-btn block large outlined color="warning" @click="resetToDefault">
                                                    <v-icon left>mdi-restore</v-icon>
                                                    Reset
                                                </v-btn>
                                            </v-col>
                                        </v-row>

                                        <!-- 保存成功メッセージ -->
                                        <v-alert type="success" dense text class="mt-4 mb-0" v-if="saveSuccess">
                                            <v-icon left small>mdi-check-circle</v-icon>
                                            Settings saved successfully!
                                        </v-alert>

                                        <!-- リセット確認ダイアログ -->
                                        <v-dialog v-model="resetDialog" max-width="400">
                                            <v-card>
                                                <v-card-title class="text-h6">
                                                    <v-icon left color="warning">mdi-alert</v-icon>
                                                    Reset to Default
                                                </v-card-title>
                                                <v-card-text>
                                                    Are you sure you want to reset all settings to default values?
                                                    This action cannot be undone.
                                                </v-card-text>
                                                <v-card-actions>
                                                    <v-spacer></v-spacer>
                                                    <v-btn text @click="resetDialog = false">Cancel</v-btn>
                                                    <v-btn color="warning" text @click="confirmReset">Reset</v-btn>
                                                </v-card-actions>
                                            </v-card>
                                        </v-dialog>
                                    </v-card-text>
                                </v-card>

                            </v-col>
                        </v-row>

                    </v-container>
                </transition>
            </v-main>

            <main-footer></main-footer>
        </template>
    </v-app>

    <style>
        .profile-card,
        .hobby-card,
        .life-journey-card,
        .job-offerings-card,
        .sound-card,
        .color-card {
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        .profile-avatar {
            border: 5px solid white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        .v-timeline-item__body {
            padding-left: 15px;
        }

        .job-offerings-card .v-list-item__title {
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
        }

        .subtitle-1 {
            margin-bottom: 0 !important;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="../../Asset/Javascript/Common.js?v=1.03"></script>


    <script>
        new Vue({
            el: '#App',
            vuetify: new Vuetify(),
            mixins: [window.Mixins_Common],
            data: {
                soundExpanded: false,
                colorExpanded: false,
                autoSave: false,
                saveSuccess: false,
                hasChanges: false,
                resetDialog: false,

                // BGMオプション
                bgmOptions: [
                    { text: 'None', value: 'none' },
                    { text: 'An Der Wiege', value: 'an_der_wiege' },
                    { text: 'Bach Prelude In C Dur', value: 'bach-prelude-in-c-dur' },
                    { text: 'Clair De Lune', value: 'clair_de_lune' },
                    { text: 'Clock Tick', value: 'clock-tick' },
                    { text: 'Gymnopedies', value: 'gymnopedies' },
                    { text: 'Lofi 1', value: 'lofi_1' },
                    { text: 'Lofi 2', value: 'lofi_2' },
                ],

                // デフォルト設定
                defaultSettings: {
                    bgm: 'none',
                    bgmVolume: 50,
                    seVolume: 50,
                    mainColor: '#CFD8DC',
                    subColor: 'rgba(0, 0, 0, 0.6)',
                },

                // 設定データ
                settings: {
                    bgm: 'none',
                    bgmVolume: 50,
                    seVolume: 50,
                    mainColor: '#CFD8DC',
                    subColor: 'rgba(0, 0, 0, 0.6)',
                },

                // 保存済みの設定(比較用)
                savedSettings: null,
            },

            mounted() {
                // ページ読み込み時に設定を復元
                this.loadSettings();
                // メインカラーを適用
                this.applyMainColor();
            },

            methods: {
                toggleCard(card) {
                    this[card + 'Expanded'] = !this[card + 'Expanded'];
                },

                // 自動保存の切り替え
                toggleAutoSave() {
                    localStorage.setItem('autoSave', JSON.stringify(this.autoSave));
                    if (this.autoSave && this.hasChanges) {
                        this.saveSettings();
                    }
                },

                // 設定変更時の処理
                onSettingChange() {
                    this.checkChanges();
                    
                    if (this.autoSave) {
                        this.saveSettings();
                    }
                },

                // 変更があるかチェック
                checkChanges() {
                    if (!this.savedSettings) {
                        this.hasChanges = false;
                        return;
                    }
                    this.hasChanges = JSON.stringify(this.settings) !== JSON.stringify(this.savedSettings);
                },

                // 設定を保存
                saveSettings() {
                    try {
                        localStorage.setItem('appSettings', JSON.stringify(this.settings));

                        // 保存済み設定を更新
                        this.savedSettings = JSON.parse(JSON.stringify(this.settings));
                        this.hasChanges = false;

                        // メインカラーを即座に適用
                        this.applyMainColor();

                        // 保存成功メッセージを表示
                        this.saveSuccess = true;

                        // 2秒後にメッセージを非表示
                        setTimeout(() => {
                            this.saveSuccess = false;
                        }, 2000);

                        console.log('Settings saved:', this.settings);
                    } catch (error) {
                        console.error('Failed to save settings:', error);
                        alert('Failed to save settings. Please try again.');
                    }
                },

                // メインカラーを適用
                applyMainColor() {
                    if (this.settings.mainColor) {
                        // htmlの背景色を設定
                        document.documentElement.style.backgroundColor = this.settings.mainColor;

                        // Vuetifyのv-applicationにも適用（ただしcanvasを使用するページは除く）
                        const vApp = document.querySelector('.v-application');
                        const canvas = document.querySelector('#ElectronShell');

                        // canvasがある場合（index.html）は背景を透明に保つ
                        if (vApp && !canvas) {
                            vApp.style.setProperty('background-color', this.settings.mainColor, 'important');
                        }
                    }
                },

                // 変更をキャンセル
                cancelChanges() {
                    if (this.savedSettings) {
                        this.settings = JSON.parse(JSON.stringify(this.savedSettings));
                        this.hasChanges = false;
                        console.log('Changes cancelled, settings restored:', this.settings);
                    }
                },

                // デフォルトへ戻す（確認ダイアログを表示）
                resetToDefault() {
                    this.resetDialog = true;
                },

                // デフォルトへ戻すことを確定
                confirmReset() {
                    this.resetDialog = false;
                    this.settings = JSON.parse(JSON.stringify(this.defaultSettings));
                    this.hasChanges = true;

                    // 自動保存がオンの場合は即座に保存
                    if (this.autoSave) {
                        this.saveSettings();
                    }

                    console.log('Settings reset to default:', this.settings);
                },

                // 設定を読み込み
                loadSettings() {
                    try {
                        // 自動保存設定を読み込み
                        const autoSaveSetting = localStorage.getItem('autoSave');
                        if (autoSaveSetting !== null) {
                            this.autoSave = JSON.parse(autoSaveSetting);
                        }

                        // アプリ設定を読み込み
                        const saved = localStorage.getItem('appSettings');
                        if (saved) {
                            const parsedSettings = JSON.parse(saved);
                            // 既存の設定とマージ(新しい設定項目が追加された場合に対応)
                            this.settings = Object.assign({}, this.settings, parsedSettings);
                            this.savedSettings = JSON.parse(JSON.stringify(this.settings));
                            console.log('Settings loaded:', this.settings);
                        } else {
                            // 初回ロード時は現在の設定を保存済みとして記録
                            this.savedSettings = JSON.parse(JSON.stringify(this.settings));
                        }
                    } catch (error) {
                        console.error('Failed to load settings:', error);
                    }
                },
            }
        })
    </script>
</body>

</html>